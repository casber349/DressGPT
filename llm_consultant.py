import os
from google import genai

class DressConsultant:
    def __init__(self):
        # å¾ç’°å¢ƒè®Šæ•¸ä¸­è®€å– API Key
        api_key = os.environ.get("GEMINI_API_KEY")
        if not api_key:
            print("âš ï¸ è­¦å‘Šï¼šæ‰¾ä¸åˆ° GEMINI_API_KEYï¼ŒLLM è«®è©¢åŠŸèƒ½å°‡ç„¡æ³•ä½¿ç”¨ã€‚")
            self.client = None
        else:
            self.client = genai.Client(api_key=api_key)
            
        self.model_name = 'gemini-2.5-flash'

    def _get_dressgpt_rank(self, score):
        """
        æ ¸å¿ƒé‚è¼¯ï¼šDressGPT 9éšå±¤ç´šä¸–ç•Œè§€
        """
        if score >= 8.0:
            return "ã€ç¥ä¹‹é ˜åŸŸã€‘(PR97+)", "é›»è¦–æ˜æ˜Ÿ/åæ¨¡ç­‰ç´šã€‚æ—¥å¸¸ç”Ÿæ´»ä¸­æ¥µç½•è¦‹ï¼Œè‡ªå¸¶å¼·å¤§æ°£å ´ã€‚", "å´‡æ‹œèˆ‡æ¬£è³"
        elif score >= 7.0:
            return "ã€ç²¾è‹±éšç´šã€‘(PR91-97)", "ç­è‰/æ ¡è‰ç­‰ç´šã€‚é«˜ç´šã€éå¸¸é †çœ¼ï¼Œå›é ­ç‡æ¥µé«˜ã€‚", "å°ˆæ¥­ä¸”å°Šé‡çš„äº¤æµ"
        elif score >= 6.0:
            return "ã€é¢¨æ ¼éšç´šã€‘(PR75-91)", "æœ‰å‹/é †çœ¼ã€‚å·²è„«é›¢è·¯äººæ„Ÿï¼Œæ“æœ‰å€‹äººé¢¨æ ¼è¨˜æ†¶é»ã€‚", "è‚¯å®šä¸¦æ¢è¨ç´°ç¯€"
        elif score >= 5.0:
            return "ã€è³ªæ„Ÿéšç´šã€‘(PR50-75)", "ç°¡ç´„/ä¹¾æ·¨ã€‚ç©¿æ­é«”é¢ï¼Œç¬¦åˆå¤§çœ¾å¯©ç¾ï¼Œæ˜¯å¤§å¤šæ•¸äººçš„ç†æƒ³ç›®æ¨™ã€‚", "é¼“å‹µä¸¦çµ¦äºˆä¿¡å¿ƒ"
        elif score >= 4.0:
            return "ã€è·¯äººéšç´šã€‘(PR25-50)", "æ™®é€š/ç„¡èŠã€‚æ²’æœ‰å¤§éŒ¯ä½†ç¼ºä¹å­˜åœ¨æ„Ÿï¼Œæ·¹æ²’åœ¨äººç¾¤ä¸­ã€‚", "ä¸­è‚¯ä¸”å…·é«”ï¼ŒæŒ‡å‡ºçªç ´é»"
        elif score >= 3.0:
            return "ã€é‡æ•´éšç´šã€‘(PR10-25)", "é›œäº‚/æµ®èª‡ã€‚å…ƒç´ éå¤šæˆ–æ­é…å¤±è¡¡ï¼Œè¦–è¦ºä¸Šä»¤äººç–²å‹ã€‚", "çŠ€åˆ©ç›´æ¥ï¼Œè¦æ±‚åšæ¸›æ³•"
        else:
            return "ã€æ··æ²Œéšç´šã€‘(PR10ä»¥ä¸‹)", "ææ€–/ç½é›£ã€‚ç¼ºä¹åŸºç¤æ•´æ½”åº¦èˆ‡é‚è¼¯ï¼Œæ€¥éœ€é‡å»ºç©¿æ­è§€ã€‚", "åš´è‚…è­¦å‘Šï¼Œæä¾›åŸºç¤ç”Ÿå­˜å»ºè­°"

    def generate_advice(self, final_score, analysis_results, is_inpainted=False):
        """
        ç”Ÿæˆè¨ºæ–·å ±å‘Šï¼šçµåˆ DressGPT ä¸–ç•Œè§€èˆ‡å®¢è§€æ•¸æ“š
        """
        if not self.client:
            return self.generate_backup_advice(final_score, analysis_results)

        # 1. è§£ææ•¸æ“š
        user_report = analysis_results.get('user_report', {})
        neighbor_report = analysis_results.get('neighbor_report', {})
        original_score = analysis_results.get('original_score', final_score)
        
        # è¨ˆç®—é€²æ­¥å¹…åº¦
        delta = final_score - original_score
        
        # 2. ç²å–éšç´šå®šä½
        current_rank, rank_desc, tone = self._get_dressgpt_rank(final_score)
        orig_rank, _, _ = self._get_dressgpt_rank(original_score)

        # 3. æ•¸æ“šæ ¼å¼åŒ–
        my_strengths = ", ".join(user_report.get('strengths', ["(æš«ç„¡é¡¯è‘—äº®é»)"]))
        my_weaknesses = ", ".join(user_report.get('weaknesses', ["(æš«ç„¡é¡¯è‘—é›·å€)"]))
        # æ¦œæ¨£æ¨™ç±¤
        target_tags = ", ".join(neighbor_report.get('good_tags', ["(æ¦œæ¨£ç„¡é¡¯è‘—äº®é»)"]))
        neighbor_id = analysis_results.get('good_id', 'Unknown')

        # 4. æ§‹å»º Prompt (æ³¨å…¥éˆé­‚çš„é—œéµ)
        # åˆ¤æ–·æ˜¯ã€ŒåŸåœ°è¸æ­¥ã€ã€ã€Œå¾®å¹…é€²æ­¥ã€é‚„æ˜¯ã€Œéšç´šè·¨è¶Šã€
        progress_context = ""
        if delta > 0.8:
            progress_context = f"ä½¿ç”¨è€…å¾ {original_score:.2f} åˆ†ç‹‚å‡è‡³ {final_score:.2f} åˆ†ï¼é€™æ˜¯ä¸€æ¬¡é©šäººçš„éšç´šè·¨è¶Šï¼ˆ{orig_rank} -> {current_rank}ï¼‰ã€‚è«‹å¤§åŠ›è®šè³é€™ç¨®æ”¹è®Šï¼Œä¸¦å¼·èª¿å–®å“æ›´æ›çš„é—œéµä½œç”¨ã€‚"
        elif delta > 0.3:
            progress_context = f"ä½¿ç”¨è€…æœ‰é¡¯è‘—é€²æ­¥ (+{delta:.2f})ï¼ŒæˆåŠŸå¾ {orig_rank} æå‡è³ªæ„Ÿã€‚è«‹è‚¯å®šé€™å€‹æ–¹å‘ã€‚"
        elif delta < -0.5:
            progress_context = f"æ³¨æ„ï¼šé‡ç¹ªå¾Œåˆ†æ•¸åè€Œä¸‹é™äº†ï¼ˆ{original_score:.2f} -> {final_score:.2f}ï¼‰ã€‚é€™é€šå¸¸æ˜¯å› ç‚ºæ›è£ç ´å£äº†åŸæœ‰çš„å’Œè«§æ„Ÿï¼Œæˆ–æ˜¯ AI ç”Ÿæˆçš„ç´°ç¯€ï¼ˆå¦‚æ‰‹æŒ‡ã€å…‰å½±ï¼‰æœ‰ç‘•ç–µã€‚è«‹å§”å©‰æŒ‡å‡ºï¼šã€Œé›–ç„¶å˜—è©¦äº†æ–°é¢¨æ ¼ï¼Œä½†ç´°ç¯€è³ªæ„Ÿç¨æœ‰æµå¤±ï¼Œå»ºè­°åœ¨æè³ªé¸æ“‡ä¸Šæ›´è¬¹æ…ã€‚ã€ä¸è¦éåº¦æ‰¹è©•ã€‚"
        else:
            progress_context = "åˆ†æ•¸æŒå¹³ã€‚é€™ä»£è¡¨ä½¿ç”¨è€…çš„åº•å­èˆ‡ AI çš„å»ºè­°å‹¢å‡åŠ›æ•µã€‚è«‹å¼·èª¿ï¼šã€Œç¶­æŒç¾ç‹€ä¹Ÿæ˜¯ä¸€ç¨®é¢¨æ ¼ï¼Œä½†æˆ‘å€‘å¯ä»¥å˜—è©¦å¾®èª¿...ã€ã€‚"

        prompt = f"""
        ä½ ç¾åœ¨æ˜¯ DressGPT çš„é¦–å¸­æ™‚å°šç¸½ç›£ã€‚ä½ çš„å¯©ç¾æ¨™æº–éå¸¸åš´æ ¼ä¸”å…·é«”ï¼Œè«‹åš´æ ¼éµå®ˆä»¥ä¸‹ã€Œä¸–ç•Œè§€ã€ä¾†æ’°å¯«è¨ºæ–·å ±å‘Šã€‚

        ã€DressGPT ä¸–ç•Œè§€ (0.00-10.00åˆ†)ã€‘
        - 3åˆ†å€ä»¥ä¸‹(0.00~3.99)ï¼šææ€–/ç½é›£ -> æ€¥éœ€æ‹¯æ•‘
        - 4åˆ†å€(4.00~4.99)ï¼šæ™®é€š/ç„¡èŠ (è·¯äºº) -> å¤§å¤šæ•¸äººçš„èµ·é»
        - 5åˆ†å€(5.00~5.99)ï¼šç°¡ç´„/ä¹¾æ·¨ -> æˆåŠŸçš„ç©¿æ­ï¼Œå€¼å¾—å˜‰è¨±
        - 6åˆ†å€(6.00~6.99)ï¼šæœ‰å‹/é †çœ¼ -> ç­è‰/æ ¡è‰ç­‰ç´š
        - 7åˆ†å€(7.00~7.99)ï¼šé«˜ç´š/èè‹± -> æ¥µå°‘è¦‹
        - 8åˆ†ä»¥ä¸Š(8.00~10.00)ï¼šç¥ä¹‹é ˜åŸŸ -> é›»è¦–æ˜æ˜Ÿç­‰ç´š

        ã€ç•¶å‰è¨ºæ–·å°è±¡ã€‘
        - ç‹€æ…‹ï¼š{'[é‡ç¹ªå¾Œçš„æ¨¡æ“¬æ•ˆæœ]' if is_inpainted else '[åŸå§‹ç…§ç‰‡è¨ºæ–·]'}
        - æœ€çµ‚å¾—åˆ†ï¼š{final_score:.2f} / 10
        - åˆ¤å®šéšç´šï¼š{current_rank} ({rank_desc})
        - é€²æ­¥ç‹€æ³ï¼š{progress_context}

        ã€å®¢è§€ç‰¹å¾µæ•¸æ“šã€‘
        1. ä»–çš„å„ªå‹¢æ¨™ç±¤ï¼š{my_strengths}
        2. ä»–çš„é›·å€æ¨™ç±¤ï¼š{my_weaknesses}
        3. åƒè€ƒæ¦œæ¨£ (ID {neighbor_id}) çš„å„ªå‹¢æ¨™ç±¤ï¼š{target_tags}

        ã€æ’°å¯«è¦æ±‚ã€‘
        1. **èªæ°£**ï¼š{tone}ã€‚è«‹å±•ç¾å°ˆæ¥­ã€çŠ€åˆ©ä½†å¯Œæœ‰å»ºè¨­æ€§çš„æ…‹åº¦ã€‚
        2. **åƒ¹å€¼è§€**ï¼šè«‹è¨˜ä½ï¼Œå°ä¸€èˆ¬äººä¾†èªªï¼Œå¾ 4 åˆ†é€²æ­¥åˆ° 5 åˆ†å·²ç¶“æ˜¯éå¸¸æ£’çš„æˆå°±ã€‚ä¸è¦å› ç‚ºæ²’é”åˆ° 8 åˆ†å°±æ‰¹è©•ä»–ï¼Œè¦ç¨±è®šä»–çš„ã€Œè„«é›¢è·¯äººæ„Ÿã€ã€‚
        3. **é‡å°æ€§**ï¼š
           - å¦‚æœæ˜¯ã€Œé‡ç¹ªå¾Œã€ï¼Œè«‹é»è©•æ–°æ›ä¸Šçš„å–®å“ï¼ˆåƒè€ƒæ¦œæ¨£æ¨™ç±¤ï¼‰æ˜¯å¦é©åˆä»–ã€‚
           - å¦‚æœåˆ†æ•¸å¡åœ¨ 5 åˆ†ä¸Šä¸‹ï¼Œè«‹å¤šè«‡è«‡ã€Œè³ªæ„Ÿã€ã€ã€Œå‰ªè£ã€èˆ‡ã€Œè‡ªä¿¡ã€ã€‚
           - å¦‚æœæœ‰é›·å€æ¨™ç±¤ï¼Œè«‹ç›´æ¥é»å‡ºä¸¦å»ºè­°å¦‚ä½•ä¿®æ­£ã€‚

        ã€è¼¸å‡ºæ ¼å¼ã€‘(è«‹ç›´æ¥è¼¸å‡ºä»¥ä¸‹ä¸‰é»ï¼Œä¸è¦æœ‰é–‹å ´ç™½)
        ### ğŸ¯ ç©¿æ­åœ°ä½
        (ä¸€å¥è©±å®šç¾©ä»–ç›®å‰çš„ç¤¾äº¤è¦–è¦ºåœ°ä½ï¼Œä¾‹å¦‚ï¼šã€Œä½ å·²ç¶“æˆåŠŸè„«é›¢äº†è·¯äººç”²çš„è¡Œåˆ—ï¼Œé€²å…¥äº†è®“äººçœ‹èµ·ä¾†èˆ’æœçš„ã€ç°¡ç´„è³ªæ„Ÿåœˆã€ã€‚ã€)

        ### âœ¨ äº®é»åˆ†æ
        (çµåˆå„ªå‹¢æ¨™ç±¤èˆ‡åˆ†æ•¸é€²è¡Œé»è©•)

        ### ğŸ’¡ å°ˆå®¶å»ºè­°
        (çµåˆé›·å€æ¨™ç±¤èˆ‡æ¦œæ¨£å–®å“ï¼Œçµ¦å‡ºå…·é«”çš„ä¸‹ä¸€æ­¥å»ºè­°ã€‚å¦‚æœæ˜¯é‡ç¹ªåœ–ï¼Œè«‹è©•è«–é€™å¥—æ–°è¡£æœçš„é©é…åº¦ã€‚)
        """

        try:
            response = self.client.models.generate_content(
                model=self.model_name,
                contents=prompt
            )
            return response.text
        except Exception as e:
            print(f"LLM Error: {e}")
            return self.generate_backup_advice(final_score, analysis_results)

    def generate_backup_advice(self, user_score, analysis_results):
        """
        å‚™ç”¨æ–¹æ¡ˆï¼šç•¶ LLM æ›æ‰æ™‚ï¼Œç”¨ä½ çš„è¦å‰‡åº«è¼¸å‡º
        """
        # 1. ç²å–éšç´šæè¿°
        rank_name, rank_desc, _ = self._get_dressgpt_rank(user_score)
        
        # 2. æ•¸æ“šæå–
        user_report = analysis_results.get('user_report', {})
        neighbor_report = analysis_results.get('neighbor_report', {})
        
        my_good = user_report.get('strengths', ["ç„¡é¡¯è‘—ç‰¹å¾µ"])
        my_bad = user_report.get('weaknesses', ["ç„¡æ˜é¡¯é›·å€"])
        neighbor_tags = neighbor_report.get('good_tags', ["ç„¡"])
        
        advice = f"""
        ### ğŸ¯ ç©¿æ­åœ°ä½
        **{rank_name}**
        å¾—åˆ†ï¼š{user_score:.2f}
        è©•èªï¼š{rank_desc}

        ### ğŸ“Š æ•¸æ“šåˆ†æ
        - **å„ªå‹¢åŸºå› **ï¼š{", ".join(my_good)}
        - **æ½›åœ¨é¢¨éšª**ï¼š{", ".join(my_bad)}
        
        ### ğŸ’¡ ç³»çµ±å»ºè­°
        æˆ‘å€‘ç‚ºæ‚¨åŒ¹é…äº† ID {analysis_results.get('good_id')} çš„é¢¨æ ¼ä½œç‚ºåƒè€ƒã€‚
        æ¦œæ¨£å„ªå‹¢ï¼š**{", ".join(neighbor_tags)}**ã€‚
        
        *(è¨»ï¼šç›®å‰ AI é¡§å•é€£ç·šå¿™ç¢Œä¸­ï¼Œæ­¤ç‚ºåŸºæ–¼è³‡æ–™åº«çš„è‡ªå‹•åŒ–ç°¡å ±)*
        """
        return advice